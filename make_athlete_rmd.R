
# Create Athlete results Rmd -------------------------------------------------


header <- paste0({
'# Competitors {#athletes}

<!-- Do not edit this file -->
<!-- This Rmd file is created using make_athlete_rmd.R -->

Competitors are list below by last name. Click a name to see all their results.

'
})



# Name list
dt_names <- dt_all_long[, .(name_last = name_last[1], name_first = name_first[1],athlete_ref = athlete_ref[1]), by = Name][order(name_last, name_first)]

dt_names[, last_initial := substr(name_last,1,1)]
dt_names[last_initial=="", last_initial := "Unknown"]

dt_names[, md_link := paste0("[",Name,"](#",athlete_ref,")")]


letter_groups <- unique(dt_names$last_initial)


name_list <- foreach(letter_i = letter_groups, .combine = paste0) %do% {
  
  paste0("\n**",letter_i,"**\n\n",
         paste0(dt_names[last_initial==letter_i]$md_link, collapse = "\n\n"),
         "\n\n")
  
}



# Competitor pages --------------------------------------------------------



repeated <- foreach(k=athletes_ordered, .combine = paste0 ) %do% {
  

  dt_all_long_athlete <- dt_all_long[Name==k]
  
  k_ref <- dt_all_long[Name==k]$athlete_ref[1]
  name_first <- dt_all_long_athlete$name_first[1]
  
  n_seasons <- length(unique(dt_all_long_athlete$season))

  n_entries_athlete_all <- dt_all_long_athlete[(is_last_entry_all) & part == "Swim", entries_total_all]
  
  paste0("## ", k, " {#", k_ref, "}",
         "\n\n", name_first, " has results for ",
         n_entries_athlete_all," ", ifelse(n_entries_athlete_all==1,"entry", "entries")
         ," over ", n_seasons, " ", ifelse(n_seasons==1,"season", "seasons"),".\n\n",
         
         
         "Scroll down to see a table and plot of all results. Season records are show in gold, season PBs are shown in pink, and invalid times in grey.\n",

'\n```{r ',k_ref,'-table}
table_athlete_all("',k,'")
```\n\n',
         
         "Tap or hover on the plots for more info. Plots show all courses together, courses other than Full are identified with a letter \"I\": Intermediate, \"D\": Double Distance, \"T\": Teams. ",
         # "Race cancellations are shown on the plot with the letter \"C\". ",


'\n```{r ',k_ref,'-plot}
plotly_athlete_all("',k,'")
```\n\n'
         
)
}

write(paste0(header, name_list, repeated),file = "01-athlete_generated.Rmd")
